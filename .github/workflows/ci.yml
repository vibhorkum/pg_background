name: CI - PostgreSQL Extension Build & Test

on:
  push:
    branches: [ master, v1.6, develop ]
  pull_request:
    branches: [ master, v1.6 ]
  workflow_dispatch:

jobs:
  test:
    name: PG ${{ matrix.pg }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        pg: [12, 13, 14, 15, 16, 17]
        include:
          # Attempt PG 18 on Ubuntu 24.04 only (container tag availability may vary)
          - os: ubuntu-24.04
            pg: 18
        exclude:
          # PG 12 frequently not available / supported well on newer distros
          - os: ubuntu-24.04
            pg: 12

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start PostgreSQL container
        run: |
          set -euo pipefail
          
          # Start PostgreSQL in a container
          docker run --name postgres-test -d \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_DB=postgres \
            -p 5432:5432 \
            postgres:${{ matrix.pg }}
          
          # Wait for PostgreSQL to be ready
          echo "Waiting for PostgreSQL to start..."
          for i in {1..30}; do
            if docker exec postgres-test pg_isready -U postgres >/dev/null 2>&1; then
              echo "PostgreSQL is ready"
              docker exec postgres-test psql -U postgres -c "SELECT version();"
              break
            fi
            echo "Still waiting... ($i/30)"
            sleep 2
          done

      - name: Install build dependencies
        run: |
          set -euo pipefail
          
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            ca-certificates \
            wget \
            gnupg \
            lsb-release \
            build-essential \
            libkrb5-dev

          # Add PGDG repo
          sudo install -d -m 0755 /usr/share/keyrings
          wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc \
            | sudo gpg --dearmor -o /usr/share/keyrings/postgresql.gpg

          echo "deb [signed-by=/usr/share/keyrings/postgresql.gpg] https://apt.postgresql.org/pub/repos/apt \
            $(lsb_release -cs)-pgdg main" \
            | sudo tee /etc/apt/sources.list.d/pgdg.list >/dev/null

          sudo apt-get update -qq

          # Install client + server-dev headers for the target major
          sudo apt-get install -y -qq \
            postgresql-client-${{ matrix.pg }} \
            postgresql-server-dev-${{ matrix.pg }}
          
          # Create symlinks for clang/llvm tools to avoid version mismatch errors
          # The PGXS build system may expect specific versions (e.g., clang-19, llvm-19)
          if [ ! -e /usr/bin/clang-19 ]; then
            sudo ln -sf /usr/bin/clang /usr/bin/clang-19 || true
          fi
          if [ ! -d /usr/lib/llvm-19 ]; then
            # Find the highest llvm version available
            LLVM_VER=$(ls -d /usr/lib/llvm-* 2>/dev/null | sort -V | tail -1 | sed 's|.*/llvm-||')
            if [ -z "$LLVM_VER" ]; then
              # Default to 18 as it's commonly available on Ubuntu 22.04/24.04
              LLVM_VER=18
            fi
            sudo mkdir -p /usr/lib/llvm-19/bin
            if [ -f "/usr/lib/llvm-${LLVM_VER}/bin/llvm-lto" ]; then
              sudo ln -sf /usr/lib/llvm-${LLVM_VER}/bin/llvm-lto /usr/lib/llvm-19/bin/llvm-lto || true
            fi
          fi
          
          echo "=== Build Environment ==="
          /usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config --version
          /usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config --includedir-server
          /usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config --pkglibdir
          echo "========================="

      - name: Build extension
        run: |
          set -euo pipefail
          
          export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config
          
          make clean
          make
          
          echo "=== Build artifacts ==="
          ls -la pg_background.so
          ls -la pg_background.control
          echo "======================="

      - name: Copy extension files into container
        run: |
          set -euo pipefail
          
          # Get PostgreSQL paths from pg_config
          PKGLIBDIR=$(/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config --pkglibdir)
          SHAREDIR=$(/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config --sharedir)
          
          echo "Container PostgreSQL paths:"
          echo "  PKGLIBDIR: $PKGLIBDIR"
          echo "  SHAREDIR: $SHAREDIR"
          
          # Copy the shared library
          docker exec postgres-test mkdir -p "$PKGLIBDIR"
          docker cp pg_background.so postgres-test:$PKGLIBDIR/pg_background.so
          
          # Copy extension control and SQL files
          docker exec postgres-test mkdir -p "$SHAREDIR/extension"
          docker cp pg_background.control postgres-test:$SHAREDIR/extension/
          docker cp pg_background--1.6.sql postgres-test:$SHAREDIR/extension/
          docker cp pg_background--1.4--1.6.sql postgres-test:$SHAREDIR/extension/
          docker cp pg_background--1.5--1.6.sql postgres-test:$SHAREDIR/extension/
          docker cp pg_background--1.4--1.5.sql postgres-test:$SHAREDIR/extension/
          docker cp pg_background--1.0--1.4.sql postgres-test:$SHAREDIR/extension/
          docker cp pg_background--1.1--1.4.sql postgres-test:$SHAREDIR/extension/
          docker cp pg_background--1.2--1.4.sql postgres-test:$SHAREDIR/extension/
          docker cp pg_background--1.3--1.4.sql postgres-test:$SHAREDIR/extension/
          
          # Optionally copy bitcode if it was built successfully
          if [ -f pg_background.bc ]; then
            echo "Copying bitcode file..."
            docker exec postgres-test mkdir -p "$PKGLIBDIR/bitcode/pg_background"
            if docker cp pg_background.bc postgres-test:$PKGLIBDIR/bitcode/pg_background/; then
              echo "Bitcode file copied successfully"
            else
              echo "Warning: Failed to copy bitcode file (non-critical)"
            fi
          fi
          
          echo "=== Verify installation in container ==="
          docker exec postgres-test ls -la "$PKGLIBDIR/pg_background.so"
          docker exec postgres-test ls -la "$SHAREDIR/extension/pg_background.control"

      - name: Run regression tests
        run: |
          set -euo pipefail
          
          export PGHOST=127.0.0.1
          export PGPORT=5432
          export PGUSER=postgres
          export PGPASSWORD=postgres
          export PGDATABASE=postgres
          export PATH="/usr/lib/postgresql/${{ matrix.pg }}/bin:$PATH"
          
          echo "=== Test Environment ==="
          psql -c "SELECT version();"
          psql -c "CREATE EXTENSION pg_background;"
          psql -c "SELECT * FROM pg_available_extensions WHERE name = 'pg_background';"
          echo "========================"
          
          # Run regression tests - tests connect to the containerized PostgreSQL
          export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config
          make installcheck REGRESS_OPTS+=" --host=$PGHOST --port=$PGPORT --user=$PGUSER"

      - name: Show test results on failure
        if: failure()
        run: |
          echo "=== Regression Diffs ==="
          cat regression.diffs 2>/dev/null || echo "No diffs file"
          echo ""
          echo "=== Regression Out ==="  
          cat regression.out 2>/dev/null || echo "No out file"
          echo ""
          echo "=== Container Logs ==="
          docker logs postgres-test 2>&1 | tail -100

      - name: Upload regression diffs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: regression-diffs-pg${{ matrix.pg }}-${{ matrix.os }}
          path: |
            regression.diffs
            regression.out
            results/

      - name: Cleanup
        if: always()
        run: |
          docker stop postgres-test || true
          docker rm postgres-test || true

  lint:
    name: Lint & Style Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-format \
            cppcheck \
            postgresql-server-dev-16

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --inconclusive --std=c11 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unmatchedSuppression \
            --error-exitcode=1 \
            pg_background.c || true  # Don't fail on warnings for now

      - name: Check code formatting
        run: |
          clang-format --dry-run --Werror pg_background.c || true  # Informational only

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: cpp

      - name: Install PostgreSQL headers
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-server-dev-16 libkrb5-dev build-essential

      - name: Create clang/llvm symlinks
        run: |
          # Create symlinks for clang/llvm tools to avoid version mismatch errors
          # The PGXS build system may expect specific versions (e.g., clang-19, llvm-19)
          if [ ! -e /usr/bin/clang-19 ]; then
            sudo ln -sf /usr/bin/clang /usr/bin/clang-19 || true
          fi
          if [ ! -d /usr/lib/llvm-19 ]; then
            # Find the highest llvm version available
            LLVM_VER=$(ls -d /usr/lib/llvm-* 2>/dev/null | sort -V | tail -1 | sed 's|.*/llvm-||')
            if [ -z "$LLVM_VER" ]; then
              # Default to 18 as it's commonly available on Ubuntu 22.04/24.04
              LLVM_VER=18
            fi
            sudo mkdir -p /usr/lib/llvm-19/bin
            if [ -f "/usr/lib/llvm-${LLVM_VER}/bin/llvm-lto" ]; then
              sudo ln -sf /usr/lib/llvm-${LLVM_VER}/bin/llvm-lto /usr/lib/llvm-19/bin/llvm-lto || true
            fi
          fi

      - name: Build for CodeQL
        run: |
          export PATH=/usr/lib/postgresql/16/bin:$PATH
          export PG_CONFIG=/usr/lib/postgresql/16/bin/pg_config
          make clean
          make

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
