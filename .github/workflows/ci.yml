name: CI - PostgreSQL Extension Build & Test

on:
  push:
    branches: [ master, v1.6, develop ]
  pull_request:
    branches: [ master, v1.6 ]
  workflow_dispatch:

jobs:
  test:
    name: PG ${{ matrix.pg }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        pg: [12, 13, 14, 15, 16, 17]
        include:
          # Test PG 18 (devel) on Ubuntu 24.04 only
          - os: ubuntu-24.04
            pg: 18
        exclude:
          # PG 18 not on Ubuntu 22.04 (may not be available)
          - os: ubuntu-22.04
            pg: 18

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL ${{ matrix.pg }}
        run: |
          # Add PostgreSQL APT repository
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          
          # Install PostgreSQL and dev headers
          sudo apt-get install -y \
            postgresql-${{ matrix.pg }} \
            postgresql-server-dev-${{ matrix.pg }} \
            libkrb5-dev \
            build-essential \
            clang
          
          # PostgreSQL may look for version-specific clang (e.g., clang-19)
          # Create symlink from clang-VERSION to clang
          CLANG_VERSION=$(clang --version | head -n1 | awk '{print $3}' | cut -d. -f1)
          if [ -n "$CLANG_VERSION" ]; then
            for ver in 14 15 16 17 18 19; do
              if [ ! -f /usr/bin/clang-${ver} ]; then
                sudo ln -sf /usr/bin/clang /usr/bin/clang-${ver}
              fi
            done
          fi
          
          # PostgreSQL creates cluster automatically during install
          # Stop all PostgreSQL services to ensure clean state
          sudo systemctl stop postgresql@*.service postgresql.service 2>/dev/null || true
          
          # Start only the specific version we're testing
          sudo pg_ctlcluster ${{ matrix.pg }} main start || sudo systemctl start postgresql@${{ matrix.pg }}-main
          
          # Verify the correct version is running
          sudo -u postgres /usr/lib/postgresql/${{ matrix.pg }}/bin/psql --version
          
          # Set postgres password
          sudo -u postgres /usr/lib/postgresql/${{ matrix.pg }}/bin/psql -c "ALTER USER postgres PASSWORD 'postgres';"

      - name: Build extension
        run: |
          export PATH=/usr/lib/postgresql/${{ matrix.pg }}/bin:$PATH
          # Explicitly pass PG_CONFIG to ensure correct version
          PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config make clean
          PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config make

      - name: Install extension
        run: |
          export PATH=/usr/lib/postgresql/${{ matrix.pg }}/bin:$PATH
          # Pass PG_CONFIG explicitly to sudo to ensure correct version
          sudo PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config make install

      - name: Run regression tests
        run: |
          export PATH=/usr/lib/postgresql/${{ matrix.pg }}/bin:$PATH
          # Grant postgres user access to working directory and all parent directories
          # Use capital X to only add execute permission to directories
          # Add write permission (w) so postgres can create test output files
          sudo chmod -R o+rwX "${GITHUB_WORKSPACE}" || true
          current_dir="${GITHUB_WORKSPACE}"
          while [ "$current_dir" != "/" ]; do
            sudo chmod o+rx "$current_dir" || true
            current_dir=$(dirname "$current_dir")
          done
          # Verify we're testing the correct PostgreSQL version
          echo "Testing PostgreSQL version:"
          sudo -u postgres /usr/lib/postgresql/${{ matrix.pg }}/bin/psql --version
          # Pass PG_CONFIG explicitly to ensure correct version is used
          sudo -u postgres PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config PATH=/usr/lib/postgresql/${{ matrix.pg }}/bin:$PATH make installcheck
        env:
          PGPORT: 5432
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: postgres

      - name: Upload regression diffs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: regression-diffs-pg${{ matrix.pg }}-${{ matrix.os }}
          path: |
            regression.diffs
            regression.out
            results/

  lint:
    name: Lint & Style Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-format \
            cppcheck \
            postgresql-server-dev-16

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --inconclusive --std=c11 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unmatchedSuppression \
            --error-exitcode=1 \
            pg_background.c || true  # Don't fail on warnings for now

      - name: Check code formatting
        run: |
          # Run clang-format check (don't modify, just report)
          clang-format --dry-run --Werror pg_background.c || true  # Informational only

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: cpp

      - name: Install PostgreSQL headers
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-server-dev-16 libkrb5-dev clang
          
          # PostgreSQL may look for version-specific clang (e.g., clang-19)
          # Create symlink from clang-VERSION to clang
          CLANG_VERSION=$(clang --version | head -n1 | awk '{print $3}' | cut -d. -f1)
          if [ -n "$CLANG_VERSION" ]; then
            for ver in 14 15 16 17 18 19; do
              if [ ! -f /usr/bin/clang-${ver} ]; then
                sudo ln -sf /usr/bin/clang /usr/bin/clang-${ver}
              fi
            done
          fi

      - name: Build for CodeQL
        run: |
          export PATH=/usr/lib/postgresql/16/bin:$PATH
          make clean
          make
        env:
          PG_CONFIG: /usr/lib/postgresql/16/bin/pg_config

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
