name: CI - PostgreSQL Extension Build & Test

on:
  push:
    branches: [ master, v1.6, develop ]
  pull_request:
    branches: [ master, v1.6 ]
  workflow_dispatch:

jobs:
  test:
    name: PG ${{ matrix.pg }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        pg: [12, 13, 14, 15, 16, 17]
        include:
          # Attempt PG 18 on Ubuntu 24.04 only (container tag availability may vary)
          - os: ubuntu-24.04
            pg: 18
        exclude:
          # PG 12 frequently not available / supported well on newer distros
          - os: ubuntu-24.04
            pg: 12

    services:
      postgres:
        image: postgres:${{ matrix.pg }}
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d postgres"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies + PG dev headers (${{ matrix.pg }})
        run: |
          set -euo pipefail

          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            wget \
            gnupg \
            lsb-release \
            build-essential \
            clang \
            libkrb5-dev

          # Add PGDG repo (stable approach: keyring + signed-by; no apt-key)
          sudo install -d -m 0755 /usr/share/keyrings
          wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc \
            | sudo gpg --dearmor -o /usr/share/keyrings/postgresql.gpg

          echo "deb [signed-by=/usr/share/keyrings/postgresql.gpg] https://apt.postgresql.org/pub/repos/apt \
            $(lsb_release -cs)-pgdg main" \
            | sudo tee /etc/apt/sources.list.d/pgdg.list >/dev/null

          sudo apt-get update

          # Install only client + server-dev headers for the target major
          sudo apt-get install -y --no-install-recommends \
            postgresql-client-${{ matrix.pg }} \
            postgresql-server-dev-${{ matrix.pg }}

          /usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config --version
          /usr/lib/postgresql/${{ matrix.pg }}/bin/psql --version

      - name: Wait for Postgres container
        env:
          PGHOST: 127.0.0.1
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
          PGDATABASE: postgres
        run: |
          set -euo pipefail
          for i in {1..30}; do
            if psql -c "select version();" >/dev/null 2>&1; then
              echo "Postgres is ready."
              psql -c "select version();"
              exit 0
            fi
            echo "Waiting for Postgres... ($i/30)"
            sleep 2
          done
          echo "Postgres did not become ready in time."
          exit 1

      - name: Build extension
        run: |
          set -euo pipefail
          
          export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config
          
          echo "=== Build Environment Diagnostics ==="
          echo "PG_CONFIG: $PG_CONFIG"
          $PG_CONFIG --version
          $PG_CONFIG --pgxs
          $PG_CONFIG --includedir-server
          $PG_CONFIG --pkglibdir
          echo "======================================"
          
          make clean
          make

      - name: Install extension
        run: |
          set -euo pipefail
          export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config
          sudo -E make install

      - name: Run regression tests
        env:
          PGHOST: 127.0.0.1
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
          PGDATABASE: postgres
        run: |
          set -euo pipefail

          export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config
          export PATH="/usr/lib/postgresql/${{ matrix.pg }}/bin:$PATH"

          echo "=== Test Environment ==="
          echo "Testing against PostgreSQL version:"
          psql -c "select version();"
          echo "========================"

          # PGXS regression tests honor PG* env vars and use pg_regress from PATH
          make installcheck REGRESS_OPTS+=" --host=$PGHOST --port=$PGPORT --user=$PGUSER"

      - name: Upload regression diffs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: regression-diffs-pg${{ matrix.pg }}-${{ matrix.os }}
          path: |
            regression.diffs
            regression.out
            results/

  lint:
    name: Lint & Style Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-format \
            cppcheck \
            postgresql-server-dev-16

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --inconclusive --std=c11 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unmatchedSuppression \
            --error-exitcode=1 \
            pg_background.c || true  # Don't fail on warnings for now

      - name: Check code formatting
        run: |
          clang-format --dry-run --Werror pg_background.c || true  # Informational only

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: cpp

      - name: Install PostgreSQL headers
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-server-dev-16 libkrb5-dev build-essential

      - name: Build for CodeQL
        run: |
          export PATH=/usr/lib/postgresql/16/bin:$PATH
          export PG_CONFIG=/usr/lib/postgresql/16/bin/pg_config
          make clean
          make

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
